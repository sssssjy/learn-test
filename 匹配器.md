# 匹配器

在 jest 中 提供了丰富的匹配器（Matchers）

```ts
test("测试加法", () => {
  expect(sum(1, 2)).toBe(3); // 断言 期望结果是3
});
```

首先 调用 expect 方法（断言方法） 返回一个 expectation 的对象
在该对象上可以使用 修饰符以及匹配器

目前 jest 中支持的修饰符:

- .not
- .resolves
- .rejects

not 修饰符：

```ts
test("测试加法", () => {
  expect(sum(1, 2)).toBe(3); // 断言 期望结果是3
  expect(sum(1, 2)).not.toBe(4); // 断言 期望结果不是4
});
```

resolves 与 rejects 和 Promise 相关

jest 内置很多的匹配器

- 常用匹配器
- 布尔值相关匹配器
- 数值相关匹配器
- 字符串相关匹配器
- 数组相关匹配器
- 异常相关匹配器
- 非对称匹配器

## 常用匹配器

toBe toEqual
toEqual 通常用于比较对象 深度比较

```ts
test("深度比较", () => {
  const obj = { name: "张三", score: { html: 100, css: 30 } };
  // expect(obj).toBe({ name: '张三', score: {html: 100, css: 30} }); // 不通过 toBe无法比较对象
  // toEqual 会递归比较所有属性
  expect(obj).toEqual({ name: "张三", score: { html: 100, css: 30 } }); // 使用toEqual进行深度比较
});
```

## 布尔值相关匹配器

一般来说 运行结果得到的是一个布尔值 使用布尔值相关匹配器时无需传参

```ts
it("布尔值相关匹配器", () => {
  const n = null;
  expect(n).toBeFalsy();
  expect(n).not.toBeTruthy();

  const a = 0;
  expect(a).toBeFalsy();
  expect(a).not.toBeTruthy();
});
```

类似布尔值匹配器一样不需要传参的常用匹配器：
toBeNull toBeDefined toBeUndefined

```ts
it("无参匹配器", () => {
  const n = null;
  expect(n).toBeNull();
  expect(n).toBeDefined();
  expect(n).not.toBeUndefined();

  const a = null;
  expect(a).toBeNull();
  expect(a).toBeDefined();
  expect(a).not.toBeUndefined();
});
```

## 数值相关匹配器

常见的就是两个数值之间的大小比较
大于 小于 大于等于 小于等于 接近（精度问题）

```ts
it("数值相关匹配器", () => {
  const value1 = 4;
  // 大于
  expect(value1).toBeGreaterThan(3);
  // 大于等于
  expect(value1).toBeGreaterThanOrEqual(4);
  // 小于
  expect(value1).toBeLessThan(5);
  // 小于等于
  expect(value1).toBeLessThanOrEqual(4);
  // 接近某个值
  // 需要注意浮点数的精度问题
  // 还接受第二个参数 用于指定位数 默认两位
  expect(0.1 + 0.2).toBeCloseTo(0.3);
  expect(0.301).toBeCloseTo(0.302, 2);
  expect(0.301).not.toBeCloseTo(0.302, 5);
});
```

需要特别注意浮点数 需要使用 toBeCloseTo 进行比较 可以设置比较的位数

## 字符串相关匹配器

toMatch 可以检查字符串是否和某一个正则表达式匹配上

```ts
it("字符串相关匹配器", () => {
  expect("this is a test").toMatch(/test/);
  expect("this is a test").not.toMatch(/abc/);
});
```

## 数组相关匹配器

常见需求：数组是否包含某一项

```ts
test("数组相关匹配器", () => {
  const shoppingList = ["牛奶", "面包", "鸡蛋", "苹果", "香蕉"];
  expect(shoppingList).toContain("鸡蛋");
  expect(shoppingList).not.toContain("西瓜");

  // toContain 用于判断数组中是否包含某个元素 全等比较
  // 不匹配 地址不同
  // 可以使用toContainEqual进行深度比较
  expect([{ name: "张三" }, { name: "李四" }]).not.toContain({ name: "张三" });
  expect([{ name: "张三" }, { name: "李四" }]).toContainEqual({ name: "张三" });

  // toContain还能比较一个字符串是否是另一个字符串的子串
  expect("hello world").toContain("world");

  // 也可用于Set
  expect(new Set(shoppingList)).toContain("苹果");
});
```

## 异常匹配器

有些时候我们需要测试 某个函数调用之后是否会抛出异常

```ts
it("异常相关匹配器", () => {
  // 测试函数是否会抛出异常
  expect(throwErrorFunction).toThrow();
  // 测试函数抛出的异常信息
  expect(throwErrorFunction).toThrow("you are using the wrong JDK version");
  // 测试函数抛出的异常类型
  expect(throwErrorFunction).toThrow(Error);
  // 测试函数抛出的异常信息是否匹配某个正则
  expect(throwErrorFunction).toThrow(/JDK version/);
});
```

## 非对称匹配器

以上都是对称匹配器
非对称匹配器：

```ts
const arr = ["张三"];
test("测试arr不包含某个元素", () => {
  // 期望这个数组不包含arr中的元素
  expect(["李四", "王五", "赵六"]).toEqual(expect.not.arrayContaining(arr));
});

const obj = { name: "张三", age: 18, score: 100 };
test("测试obj不包含某些键值对", () => {
  // 期望这个对象不包含obj中的某些键值对 全等
  expect({ name: "李四", age: 18, score: 100 }).toEqual(
    expect.not.objectContaining(obj)
  );
});
```

这种非对称匹配器 toEqual 匹配其中是一段类似描述的信息

## 部分源码

在源码中 所有的匹配器都放在一个名为 matchers 的对象中

```ts
const matchers = {
    toBe: (){/* ... */},
    toBeCloseTo: (){/* ... */}
    ...
}
```

在 expect 方法中 调用该方法之后会返回一个 expectation 对象

```ts
const expectation = {
    .not: {},
    .rejects: {.not: {}},
    .resolves: {.not: {}}
}
```

最后会为 expectation 对象添加所有的匹配器方法

```ts
const expect = () => {
    // 获取所有的matchers

    // 对外返回该对象
    const expectation = {
        .not: {},
        .rejects: {.not: {}},
        .resolves: {.not: {}}
    }

    // 将matchers对象上所有的匹配器添加到expectation对象上
    Object.keys(matchers).forEach(name => {
        expectation[name] = matchers[name]
        // ...
    })

    return expectation;
}
```

总结：
本次主要介绍jest各种匹配器以及修饰符

修饰符只有3个：

- .not
- .resolves
- .rejects

还有各种匹配器：

- 常用匹配器
- 布尔值相关匹配器
- 数值相关匹配器
- 字符串相关匹配器
- 数组相关匹配器
- 异常相关匹配器
- 非对称匹配器
